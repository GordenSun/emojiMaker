<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表情包网格切分工具</title>
    <!-- Tailwind CSS (通过 CDN 加载，无需本地安装) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- JSZip 用于打包下载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
        }
        /* 棋盘格背景，用于显示透明图片 */
        .checkerboard {
            background-image: 
                linear-gradient(45deg, #e5e7eb 25%, transparent 25%), 
                linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #e5e7eb 75%), 
                linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        /* 加载动画 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i data-lucide="scissors" class="text-blue-600 w-6 h-6"></i>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                    表情包切分神器
                </h1>
            </div>
            <div class="text-sm text-slate-500 hidden sm:block">
                纯前端处理 | 安全无上传
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- 左侧控制面板 -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- 上传区域 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="upload" class="w-5 h-5 text-slate-400"></i> 第一步：上传图片
                    </h2>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-blue-50 hover:border-blue-400 transition-colors group">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="image-plus" class="w-8 h-8 mb-2 text-slate-400 group-hover:text-blue-500"></i>
                            <p class="text-sm text-slate-500 group-hover:text-blue-600">点击或拖拽上传</p>
                        </div>
                        <input id="fileInput" type="file" class="hidden" accept="image/*" />
                    </label>
                </div>

                <!-- 设置区域 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 opacity-50 pointer-events-none transition-all duration-300" id="settingsPanel">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="sliders" class="w-5 h-5 text-slate-400"></i> 第二步：调整参数
                    </h2>
                    
                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">行数 (Rows)</label>
                                <input type="number" id="rowsInput" value="4" min="1" max="20" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">列数 (Cols)</label>
                                <input type="number" id="colsInput" value="6" min="1" max="20" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="block text-sm font-medium text-slate-700">去除边框 (Padding)</label>
                                <span id="paddingVal" class="text-xs font-mono bg-blue-100 text-blue-700 px-2 py-0.5 rounded">4px</span>
                            </div>
                            <input type="range" id="paddingInput" min="0" max="100" value="4" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                            <p class="text-xs text-slate-500 mt-1">向内收缩红框，避开黑色分割线。</p>
                        </div>

                        <button id="sliceBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg active:transform active:scale-95">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                            开始切分
                        </button>
                    </div>
                </div>

            </div>

            <!-- 右侧预览和结果区域 -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- 画布预览 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 min-h-[400px] flex flex-col">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="eye" class="w-5 h-5 text-slate-400"></i> 实时预览 (红框为保留区域)
                    </h2>
                    <div class="relative flex-1 bg-slate-100 rounded-xl overflow-hidden flex items-center justify-center border border-slate-200 checkerboard" id="canvasContainer">
                        <p class="text-slate-400 flex items-center gap-2" id="placeholderText">
                            <i data-lucide="image" class="w-5 h-5"></i>
                            请先上传图片
                        </p>
                        <canvas id="previewCanvas" class="max-w-full max-h-[600px] shadow-lg hidden"></canvas>
                    </div>
                </div>

                <!-- 结果网格 -->
                <div id="resultsArea" class="hidden">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                        <div class="flex flex-col">
                            <h2 class="text-lg font-semibold flex items-center gap-2">
                                <i data-lucide="grid" class="w-5 h-5 text-slate-400"></i> 切分结果
                            </h2>
                            <span class="text-xs text-slate-500 mt-1">点击单个下载，或使用右侧按钮全部下载</span>
                        </div>
                        
                        <!-- 全部下载按钮 -->
                        <button id="downloadAllBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition-all shadow-sm active:transform active:scale-95 w-full sm:w-auto justify-center">
                            <i data-lucide="archive" class="w-4 h-4"></i>
                            <span>一键打包下载 (.zip)</span>
                        </button>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div id="gridOutput" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4">
                            <!-- JS 会在这里插入切片 -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // 初始化图标
        lucide.createIcons();

        // 获取 DOM 元素
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        const settingsPanel = document.getElementById('settingsPanel');
        const rowsInput = document.getElementById('rowsInput');
        const colsInput = document.getElementById('colsInput');
        const paddingInput = document.getElementById('paddingInput');
        const paddingVal = document.getElementById('paddingVal');
        const sliceBtn = document.getElementById('sliceBtn');
        const gridOutput = document.getElementById('gridOutput');
        const resultsArea = document.getElementById('resultsArea');
        const canvasContainer = document.getElementById('canvasContainer');
        const placeholderText = document.getElementById('placeholderText');
        const downloadAllBtn = document.getElementById('downloadAllBtn');

        let originalImage = null;
        let generatedSlices = [];

        // 绑定事件
        fileInput.addEventListener('change', handleImageUpload);
        
        [rowsInput, colsInput, paddingInput].forEach(el => {
            el.addEventListener('input', () => {
                updatePaddingLabel();
                drawPreview();
            });
        });

        sliceBtn.addEventListener('click', sliceImage);
        downloadAllBtn.addEventListener('click', downloadAll);

        function updatePaddingLabel() {
            paddingVal.innerText = `${paddingInput.value}px`;
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                originalImage = new Image();
                originalImage.onload = function() {
                    settingsPanel.classList.remove('opacity-50', 'pointer-events-none');
                    canvas.classList.remove('hidden');
                    placeholderText.classList.add('hidden');
                    resultsArea.classList.add('hidden');
                    
                    // 默认预设
                    rowsInput.value = 4;
                    colsInput.value = 6;
                    paddingInput.value = 15;
                    updatePaddingLabel();

                    drawPreview();
                    canvasContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                originalImage.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }

        function drawPreview() {
            if (!originalImage) return;

            canvas.width = originalImage.width;
            canvas.height = originalImage.height;

            ctx.drawImage(originalImage, 0, 0);

            const rows = parseInt(rowsInput.value) || 1;
            const cols = parseInt(colsInput.value) || 1;
            const padding = parseInt(paddingInput.value) || 0;

            const cellWidth = canvas.width / cols;
            const cellHeight = canvas.height / rows;

            ctx.lineWidth = Math.max(2, canvas.width / 500);
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const x = c * cellWidth;
                    const y = r * cellHeight;
                    
                    const cutX = x + padding;
                    const cutY = y + padding;
                    const cutW = cellWidth - (padding * 2);
                    const cutH = cellHeight - (padding * 2);

                    if (cutW > 0 && cutH > 0) {
                        // 画红框
                        ctx.strokeStyle = 'rgba(239, 68, 68, 0.8)';
                        ctx.strokeRect(cutX, cutY, cutW, cutH);
                        
                        // 蒙版遮罩
                        ctx.fillStyle = 'rgba(0,0,0,0.3)';
                        ctx.fillRect(x, y, cellWidth, padding); // 上
                        ctx.fillRect(x, y + cellHeight - padding, cellWidth, padding); // 下
                        ctx.fillRect(x, y + padding, padding, cellHeight - (padding * 2)); // 左
                        ctx.fillRect(x + cellWidth - padding, y + padding, padding, cellHeight - (padding * 2)); // 右
                    }
                }
            }
        }

        function sliceImage() {
            if (!originalImage) return;

            gridOutput.innerHTML = '';
            resultsArea.classList.remove('hidden');
            generatedSlices = [];

            const rows = parseInt(rowsInput.value);
            const cols = parseInt(colsInput.value);
            const padding = parseInt(paddingInput.value);

            const cellWidth = originalImage.width / cols;
            const cellHeight = originalImage.height / rows;

            let count = 0;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const tempCanvas = document.createElement('canvas');
                    const tCtx = tempCanvas.getContext('2d');

                    const srcX = (c * cellWidth) + padding;
                    const srcY = (r * cellHeight) + padding;
                    const srcW = cellWidth - (padding * 2);
                    const srcH = cellHeight - (padding * 2);

                    if (srcW <= 0 || srcH <= 0) continue;

                    tempCanvas.width = srcW;
                    tempCanvas.height = srcH;

                    tCtx.drawImage(originalImage, srcX, srcY, srcW, srcH, 0, 0, srcW, srcH);

                    const imgUrl = tempCanvas.toDataURL('image/png');
                    const fileName = `sticker_${count + 1}.png`;
                    
                    generatedSlices.push({ name: fileName, data: imgUrl });

                    const wrapper = document.createElement('div');
                    wrapper.className = "group relative aspect-square bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-all cursor-pointer checkerboard";
                    
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.className = "w-full h-full object-contain p-2";
                    
                    const overlay = document.createElement('div');
                    overlay.className = "absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity";
                    overlay.innerHTML = `<i data-lucide="download" class="text-white w-6 h-6"></i>`;
                    
                    wrapper.appendChild(img);
                    wrapper.appendChild(overlay);

                    wrapper.onclick = () => {
                        const link = document.createElement('a');
                        link.download = fileName;
                        link.href = imgUrl;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };

                    gridOutput.appendChild(wrapper);
                    count++;
                }
            }

            lucide.createIcons();
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }

        async function downloadAll() {
            if (generatedSlices.length === 0) return;

            const btnOriginalText = downloadAllBtn.innerHTML;
            downloadAllBtn.disabled = true;
            downloadAllBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin-custom"></i> <span>打包中...</span>`;
            lucide.createIcons();

            try {
                const zip = new JSZip();
                generatedSlices.forEach(slice => {
                    const base64Data = slice.data.split(',')[1];
                    zip.file(slice.name, base64Data, {base64: true});
                });
                const content = await zip.generateAsync({type: "blob"});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `stickers_pack_${Date.now()}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error(err);
                alert("打包失败，请重试");
            } finally {
                downloadAllBtn.disabled = false;
                downloadAllBtn.innerHTML = btnOriginalText;
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>
